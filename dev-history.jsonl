{"type": "project_info", "name": "BoBB - Bot Builder Bot", "version": "0.1.0", "description": "A Discord bot platform that creates other Discord bots using OpenCode AI servers", "runtime": "Bun", "created": "2026-01-21"}
{"type": "architecture", "pattern": "thin_client", "description": "Discord bots are thin clients that forward messages to OpenCode servers for AI processing. Responses come back via MCP tools writing to file queues that the thin client watches and sends to Discord."}
{"type": "implementation_phase", "phase": 1, "name": "BoBB Thin Client Setup", "status": "completed", "files_created": ["src/index.ts", "src/bot-manager.ts", "package.json", "tsconfig.json", ".env.example"], "description": "Set up the Discord.js thin client with BotManager class to handle multiple bot instances, message routing, and DM handling."}
{"type": "implementation_phase", "phase": 2, "name": "OpenCode Server Integration", "status": "completed", "files_created": ["src/opencode-bridge.ts", "opencode.json", "AGENTS.md"], "description": "Created OpenCodeBridge class to communicate with OpenCode HTTP API. Set up BoBB's persona and instructions in AGENTS.md."}
{"type": "implementation_phase", "phase": 3, "name": "Discord Response Skill + MCP Tool", "status": "completed", "files_created": ["tools/mcp_discord.py", ".opencode/skills/respond-discord/SKILL.md", "src/message-queue.ts"], "description": "Created MCP server for Discord messaging that writes pending messages to file queue. Thin client watches and sends to Discord."}
{"type": "implementation_phase", "phase": 4, "name": "Bot Creation Skill + MCP Tool", "status": "completed", "files_created": ["tools/mcp_agent_manager.py", ".opencode/skills/create-bot/SKILL.md", "agents/registry.json"], "description": "Created MCP server for agent management with tools to create, list, and activate child bot agents."}
{"type": "implementation_phase", "phase": 5, "name": "Token Handling + Child Bot Activation", "status": "completed", "files_created": ["src/activation-watcher.ts"], "description": "Created activation watcher that monitors for new agent activations and starts child bot Discord connections."}
{"type": "debug_session", "date": "2026-01-21", "issue": "OpenCode SDK version error", "error": "No version matching ^0.1.0", "attempted": ["Used version ^0.1.0 based on assumption"], "solution": "Checked npm registry, correct version is ^1.1.28", "file_changed": "package.json"}
{"type": "debug_session", "date": "2026-01-21", "issue": "Bun not installed", "error": "command not found: bun", "attempted": ["Ran bun install directly"], "solution": "Installed Bun via curl: curl -fsSL https://bun.sh/install | bash, then export PATH=\"$HOME/.bun/bin:$PATH\"", "file_changed": null}
{"type": "debug_session", "date": "2026-01-21", "issue": "OpenCode MCP config format wrong", "error": "ConfigInvalidError - Unrecognized keys: command, args", "attempted": ["Used format {command: 'python3', args: [...]}"], "solution": "Correct format requires type: 'local', enabled: true, and command as array: {type: 'local', command: ['python3', 'tools/mcp_discord.py'], enabled: true}", "file_changed": "opencode.json"}
{"type": "debug_session", "date": "2026-01-21", "issue": "OpenCode health check failing", "error": "client.global.health is not a function", "attempted": ["Called client.global.health() as documented"], "solution": "SDK doesn't have global.health(). Changed to use client.session.list() as health check instead", "file_changed": "src/opencode-bridge.ts"}
{"type": "debug_session", "date": "2026-01-21", "issue": "Session ID format error", "error": "ZodError: sessionID must start with 'ses'", "attempted": ["Stored session.id directly"], "solution": "SDK returns {data: {id: 'ses_...'}} - need to access session.data.id not session.id", "file_changed": "src/opencode-bridge.ts"}
{"type": "debug_session", "date": "2026-01-21", "issue": "Model not found error", "error": "ProviderModelNotFoundError: anthropic/claude-sonnet-4-20250514", "attempted": ["Used Anthropic model without credentials"], "solution": "User only has Google OAuth configured. Changed model to google/gemini-2.0-flash", "file_changed": "opencode.json"}
{"type": "debug_session", "date": "2026-01-21", "issue": "Gemini thinking mode not supported", "error": "thinking is not supported by this model", "attempted": ["Used google/gemini-2.0-flash"], "solution": "Changed to google/gemini-2.5-flash which supports thinking mode", "file_changed": "opencode.json"}
{"type": "debug_session", "date": "2026-01-21", "issue": "No response from OpenCode", "error": "Response extraction returned null", "attempted": ["Looked for result.messages[].parts"], "solution": "SDK returns result.data.parts not result.messages. Changed extraction to filter result.data.parts for type='text'", "file_changed": "src/opencode-bridge.ts"}
{"type": "file_documentation", "path": "src/index.ts", "purpose": "Main entry point", "description": "Initializes BotManager, MessageQueue, ActivationWatcher, and OpenCodeBridge. Sets up handlers for Discord mentions, DMs, MCP tool messages, and agent activations. Starts BoBB on port 4096.", "key_functions": ["main()", "forwardToOpenCode()"]}
{"type": "file_documentation", "path": "src/bot-manager.ts", "purpose": "Discord bot lifecycle management", "description": "BotManager class that handles starting/stopping multiple Discord.js clients. Supports message handlers for mentions and DMs. Uses Partials for DM support.", "key_functions": ["startBot()", "stopBot()", "onMessage()", "onDM()", "getAllBots()"]}
{"type": "file_documentation", "path": "src/opencode-bridge.ts", "purpose": "OpenCode HTTP API client", "description": "OpenCodeBridge class wrapping @opencode-ai/sdk. Creates sessions and sends prompts to OpenCode server. Extracts text responses from result.data.parts.", "key_functions": ["sendMessage()", "isHealthy()", "getSession()", "formatDiscordMessage()"]}
{"type": "file_documentation", "path": "src/message-queue.ts", "purpose": "MCP tool message processing", "description": "MessageQueue class that watches agents/.pending/ for JSON files written by MCP tools. Processes and deletes files, calling registered handler to send to Discord.", "key_functions": ["start()", "stop()", "onMessage()", "processFile()"]}
{"type": "file_documentation", "path": "src/activation-watcher.ts", "purpose": "Child agent activation", "description": "ActivationWatcher class that watches agents/.activations/ for new agent activation requests. Triggers bot startup when files appear.", "key_functions": ["start()", "stop()", "onActivation()", "processFile()"]}
{"type": "file_documentation", "path": "tools/mcp_discord.py", "purpose": "Discord MCP server", "description": "MCP server exposing send_message tool. Writes pending messages to agents/.pending/ as JSON files. Uses JSON-RPC over stdio.", "key_functions": ["handle_send_message()", "handle_request()", "main()"]}
{"type": "file_documentation", "path": "tools/mcp_agent_manager.py", "purpose": "Agent management MCP server", "description": "MCP server for creating and managing child bot agents. Tools: create_agent, list_agents, get_agent, get_pending_agents, activate_agent, find_agent_by_name. Creates agent directories with opencode.json and AGENTS.md.", "key_functions": ["handle_create_agent()", "handle_activate_agent()", "handle_request()"]}
{"type": "file_documentation", "path": "opencode.json", "purpose": "OpenCode configuration", "description": "Configures OpenCode server for BoBB. Sets model to google/gemini-2.5-flash. Registers two MCP servers: discord and agent-manager.", "current_model": "google/gemini-2.5-flash"}
{"type": "file_documentation", "path": "AGENTS.md", "purpose": "BoBB persona and instructions", "description": "Defines BoBB's persona as a friendly bot builder assistant. Lists available skills (create-bot, respond-discord) and tools (send_message, create_agent, etc.). Includes rules for Discord message limits and response format."}
{"type": "file_documentation", "path": ".opencode/skills/create-bot/SKILL.md", "purpose": "Bot creation workflow", "description": "Step-by-step skill for creating new Discord bots. Process: gather requirements (name, persona), use create_agent tool, guide user through Discord Developer Portal setup, wait for token via DM."}
{"type": "file_documentation", "path": ".opencode/skills/respond-discord/SKILL.md", "purpose": "Discord response formatting", "description": "Skill for formatting and sending Discord messages. Guidelines for staying concise (2000 char limit), staying in character, and using send_message MCP tool."}
{"type": "data_flow", "name": "Discord to OpenCode", "steps": ["1. User mentions @BoBB in Discord", "2. Discord.js receives messageCreate event", "3. BotManager calls messageHandler", "4. index.ts calls forwardToOpenCode()", "5. OpenCodeBridge.sendMessage() creates/reuses session", "6. Sends prompt to OpenCode HTTP API", "7. Extracts text response from result.data.parts"]}
{"type": "data_flow", "name": "OpenCode to Discord", "steps": ["1. OpenCode agent uses send_message MCP tool", "2. mcp_discord.py writes JSON to agents/.pending/", "3. MessageQueue watches directory via fs.watch()", "4. Reads JSON file and calls handler", "5. index.ts fetches Discord channel", "6. Sends message via Discord.js", "7. Deletes processed JSON file"]}
{"type": "data_flow", "name": "Agent Activation", "steps": ["1. User DMs bot token to BoBB", "2. OpenCode agent uses activate_agent MCP tool", "3. mcp_agent_manager.py writes to agents/.activations/", "4. ActivationWatcher detects new file", "5. Creates new OpenCodeBridge for child agent", "6. Starts new Discord.js client with token", "7. Deletes activation file"]}
{"type": "directory_structure", "layout": {"src/": "TypeScript source files", "tools/": "Python MCP servers", "agents/": "Child agent directories and registry", "agents/.pending/": "Pending Discord messages queue", "agents/.activations/": "Agent activation signals", ".opencode/skills/": "OpenCode skill definitions"}}
{"type": "dependencies", "runtime": "Bun", "packages": {"@opencode-ai/sdk": "^1.1.28", "discord.js": "^14.14.1", "typescript": "^5.0.0", "@types/bun": "latest"}}
{"type": "environment_variables", "BOBB_DISCORD_TOKEN": "Discord bot token for BoBB (required)"}
{"type": "startup_commands", "opencode_server": "opencode serve --port 4096", "thin_client": "bun run dev", "note": "Start OpenCode server BEFORE thin client for proper health check"}
{"type": "known_issues", "issue": "Discord.js deprecation warning", "message": "ready event renamed to clientReady in v15", "severity": "low", "workaround": "Harmless warning, no action needed"}
{"type": "sdk_gotchas", "sdk": "@opencode-ai/sdk", "gotchas": ["session.create() returns {data: {id}} not {id}", "No global.health() method - use session.list() for health check", "prompt() returns {data: {parts}} not {messages}", "Text responses have type='text' in parts array"]}
{"type": "opencode_config_gotchas", "gotchas": ["MCP servers need type: 'local' and enabled: true", "command must be array not string with args", "Model format is provider/model-id"]}
